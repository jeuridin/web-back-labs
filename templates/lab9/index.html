{% extends 'base.html' %}

{% block main %}
<style>

body { font-family: Arial, sans-serif; margin: 0; }
#panel { background: #fff; padding: 10px; }
    #gifts {
    position: relative;
    height: 80vh;
}

.gift {
    position: absolute;
    width: 90px; 
    height: auto;
    cursor: pointer;
}

.gift img {
    display: block;
    width: 100%;
    height: auto;
    object-fit: contain;
}

</style>

<div id="panel">
    <input id="username" placeholder="Логин">
    <input id="password" type="password" placeholder="Пароль">

    <button onclick="register()">Регистрация</button>
    <button onclick="login()">Войти</button>
    <button onclick="logout()">Выйти</button>
    <button id="santa" onclick="santa()" style="display:none">Дед Мороз</button>

    <span>Открыто: <b id="count">0</b>/3</span>
</div>

<div id="gifts"></div>
{% endblock %}

{% block script %}
<script>
function loadGifts() {
    fetch('/lab9/state')
    .then(function(resp) { return resp.json(); })
    .then(function(d) {
        document.getElementById('count').innerText = d.opened_count;
        document.getElementById('santa').style.display = d.logged_in ? 'inline-block' : 'none';

        var giftsDiv = document.getElementById('gifts');
        giftsDiv.innerHTML = '';

        for(var i = 0; i < d.positions.length; i++) {
            var p = d.positions[i];
            var div = document.createElement('div');
            div.className = 'gift';
            div.style.top = p.top;
            div.style.left = p.left;

            div.onclick = (function(id) {
                return function() { openBox(id); };
            })(p.id);

            var img = document.createElement('img');
            img.src = d.opened_boxes.includes(p.id)
                ? '/static/lab9/gift' + (p.id + 1) + '.png'
                : '/static/lab9/box' + (p.id + 1) + '.png';

            div.appendChild(img);
            giftsDiv.appendChild(div);
        }
    });
}

function register() {
    var username = document.getElementById('username').value;
    var password = document.getElementById('password').value;

    fetch('/lab9/register', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({username: username, password: password})
    })
    .then(function(r){ return r.json(); })
    .then(function(d){
        alert(d.ok ? 'Зарегистрирован' : d.error);
    });
}

function login() {
    var username = document.getElementById('username').value;
    var password = document.getElementById('password').value;

    fetch('/lab9/login', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({username: username, password: password})
    })
    .then(function(r){ return r.json(); })
    .then(function(d){
        if(d.ok) loadGifts();
        else alert(d.error);
    });
}

function logout() {
    fetch('/lab9/logout', {method:'POST'})
    .then(function() { loadGifts(); });
}

function openBox(id) {
    fetch('/lab9/open', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({id: id})
    })
    .then(function(r){ return r.json(); })
    .then(function(d){
        if(d.error) alert(d.error);
        else alert(d.message);
        loadGifts();
    });
}
function santa() {
    fetch('/lab9/santa_reset', {method:'POST'})
    .then(function(r){ return r.json(); })
    .then(function(d){
        if(d.error) alert(d.error);
        loadGifts();
    });
}
document.addEventListener('DOMContentLoaded', function() {
    loadGifts();
});

</script>
{% endblock %}
