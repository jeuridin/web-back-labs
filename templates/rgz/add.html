{% extends 'base.html' %}

{% block lab %}Добавление сотрудника{% endblock %}

{% block script %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('addEmployeeForm');
    const messageDiv = document.getElementById('message');
    
    form.addEventListener('submit', function(event) {
        event.preventDefault();
        
        // Получаем значения
        const employee = {
            full_name: document.getElementById('full_name').value.trim(),
            position: document.getElementById('position').value.trim(),
            gender: document.getElementById('gender').value,
            phone: document.getElementById('phone').value.trim(),
            email: document.getElementById('email').value.trim(),
            trial: document.getElementById('trial').value,
            hire_date: document.getElementById('hire_date').value
        };
        
        // Очищаем ошибки
        document.querySelectorAll('.error-message').forEach(el => {
            el.textContent = '';
        });
        messageDiv.textContent = '';
        
        // Валидация
        let isValid = true;
        
        if (!employee.full_name) {
            document.getElementById('fullname-error').textContent = 'Введите ФИО';
            isValid = false;
        }
        
        if (!employee.position) {
            document.getElementById('position-error').textContent = 'Введите должность';
            isValid = false;
        }
        
        if (!employee.gender) {
            document.getElementById('gender-error').textContent = 'Выберите пол';
            isValid = false;
        }
        
        if (!employee.email) {
            document.getElementById('email-error').textContent = 'Введите email';
            isValid = false;
        } else if (!isValidEmail(employee.email)) {
            document.getElementById('email-error').textContent = 'Введите правильный email';
            isValid = false;
        }
        
        if (!employee.hire_date) {
            document.getElementById('hire-date-error').textContent = 'Выберите дату устройства';
            isValid = false;
        }
        
        if (!isValid) return;
        
        // Меняем текст кнопки
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Добавляем...';
        submitBtn.disabled = true;
        
        // Отправляем данные
        fetch('/rgz/rest-api/employees', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(employee)
        })
        .then(response => {
            console.log('Статус ответа:', response.status);
            console.log('Заголовки ответа:', response.headers);
            return response.json();
        })
        .then(data => {
            console.log('Полные данные ответа:', data);
            
            // Пробуем разные варианты успешного ответа
            if (data.success || data.message || data.id || data.employee_id || data.status === 'success') {
                messageDiv.textContent = '✓ Сотрудник успешно добавлен!';
                messageDiv.style.color = 'green';
                
                // Очищаем форму
                form.reset();
                
                // Через 1.5 секунды переходим на главную
                setTimeout(() => {
                    window.location.href = '/rgz';
                }, 1500);
            } else {
                // Показываем то, что вернул сервер
                console.log('Ошибка от сервера:', data);
                messageDiv.textContent = 'Ошибка: ' + (data.error || JSON.stringify(data));
                messageDiv.style.color = 'red';
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Ошибка запроса:', error);
            messageDiv.textContent = 'Ошибка соединения с сервером';
            messageDiv.style.color = 'red';
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        });
    });
    
    function isValidEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
    }
});
</script>
{% endblock %}

{% block style %}
<link rel="stylesheet" href="{{ url_for('static', filename='rgz/main.css')}}">
<style>
#addEmployeeForm {
    max-width: 500px;
    margin: 30px auto;
    padding: 25px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

#addEmployeeForm label {
    display: block;
    margin-bottom: 15px;
    font-weight: bold;
    color: #333;
}

#addEmployeeForm input,
#addEmployeeForm select {
    width: 100%;
    padding: 10px;
    margin-top: 5px;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-sizing: border-box;
    font-size: 14px;
}

#addEmployeeForm input:focus,
#addEmployeeForm select:focus {
    outline: none;
    border-color: #4a6fa5;
    box-shadow: 0 0 0 2px rgba(74, 111, 165, 0.2);
}

#addEmployeeForm button {
    width: 100%;
    padding: 12px;
    background: #4a6fa5;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    cursor: pointer;
    margin-top: 20px;
    transition: background-color 0.3s;
}

#addEmployeeForm button:hover {
    background: #3a5a8a;
}

#addEmployeeForm button:disabled {
    background: #cccccc;
    cursor: not-allowed;
}

.error-message {
    color: #dc3545;
    font-size: 14px;
    margin-top: 5px;
    min-height: 20px;
}

#message {
    text-align: center;
    padding: 15px;
    margin: 20px auto;
    max-width: 500px;
    border-radius: 4px;
    font-weight: bold;
}
</style>
{% endblock %}

{% block main %}
<div style="max-width: 600px; margin: 0 auto; padding: 20px;">
    <h2 style="text-align: center; margin-bottom: 30px; color: #333;">Добавление нового сотрудника</h2>
    
    <form id="addEmployeeForm">
        <label>ФИО: <input type="text" id="full_name" required placeholder="Иванов Иван Иванович"></label>
        <div id="fullname-error" class="error-message"></div>
        
        <label>Должность: <input type="text" id="position" required placeholder="Менеджер"></label>
        <div id="position-error" class="error-message"></div>
        
        <label>Пол:
            <select id="gender" required>
                <option value="">Выберите пол</option>
                <option value="М">Мужской</option>
                <option value="Ж">Женский</option>
            </select>
        </label>
        <div id="gender-error" class="error-message"></div>
        
        <label>Телефон: <input type="text" id="phone" placeholder="+7 (999) 123-45-67"></label>
        <div id="phone-error" class="error-message"></div>
        
        <label>Email: <input type="email" id="email" required placeholder="ivanov@example.com"></label>
        <div id="email-error" class="error-message"></div>
        
        <label>Испытательный срок:
            <select id="trial">
                <option value="">Выберите</option>
                <option value="1">Да</option>
                <option value="0">Нет</option>
            </select>
        </label>
        <div id="trial-error" class="error-message"></div>
        
        <label>Дата устройства: 
            <input type="date" id="hire_date" required>
        </label>
        <div id="hire-date-error" class="error-message"></div>
        
        <button type="submit">Сохранить</button>
    </form>
    
    <p id="message"></p>
</div>
{% endblock %}